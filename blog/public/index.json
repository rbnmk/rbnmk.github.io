[{"content":"Failed to save Kubernetes service - addonProfiles.ingressApplicationGateway.config.applicationGatewayId is invalid I ran into an issue when deploying Azure Kubernetes services using ARM Templates. We previously set the ingress-agw addon to configure the ingress using an application gateway. We recently moved to the Azure Application Gateway Ingress Controller using Helm and simply set the addon configuration to \u0026rsquo;null\u0026rsquo; but that creates a conflict when making other changes such as changing the SKU (Pricing Tier) of the cluster.\nWe noticed that our clusters were set to the Free SKU but we are actually deploying with the Standard SKU. When we tried to change the SKU in the portal we got the following error:\nError description in text:\nFailed to save Kubernetes service. Error: Property id \u0026rsquo;\u0026rsquo; at path \u0026lsquo;properties.addonProfiles.ingressApplicationGateway.config.applicationGatewayId\u0026rsquo; is invalid. Expect fully qualified resource Id that start with \u0026lsquo;/subscriptions/{subscriptionId}\u0026rsquo; or \u0026lsquo;/providers/{resourceProviderNamespace}/\u0026rsquo; {: .notice\u0026ndash;warning}\nThe solution This Github issue{:target=\u0026quot;_blank\u0026quot;} actually pointed me in the right direction after I tried removing the addon from the ARM-template didnt fix it.\nFor this solution I used Azure CLI (PowerShell) and the AKS-preview addon. Make sure you set your az cli context to the subscription where your AKS-cluster is created.\nPlease check carefully if you can run this command against your environment before executing! {: .notice\u0026ndash;warning}\n(Optional) Set the subscription context $aksSubscriptionName = \u0026#34;aksSubscription\u0026#34; az account set --subscription $aksSubscriptionName Disable the add-on $aksName = \u0026#34;aks\u0026#34; $aksRgName = \u0026#34;aksrg\u0026#34; az aks disable-addons --addon \u0026#39;ingress-appgw\u0026#39; --resource-group $aksRgName -n $aksName Update the cluster SKU I still could not update the SKU using my ARM-template so I used Azure CLI to configure (update the sku) for my AKS-cluster.\n$aksName = \u0026#34;aks\u0026#34; $aksRgName = \u0026#34;aksrg\u0026#34; az aks update --resource-group $aksRgName -n $aksName --tier \u0026#39;Standard\u0026#39; Now verify if the cluster is set to the Standard SKU:\nI also checked if the SKU is set correctly after an ARM-template deployment. It was not reset to Free so I think it\u0026rsquo;s all good now. I hope that Microsoft Azure will provide better error messages in the future for these kind of issues.\nThat\u0026rsquo;s it for today, hope it helped you out - would be happy to know if it helped you (or not)!\n","permalink":"http://localhost:1313/posts/2023-07-12-failed-to-save-kubernetes-service-applicationgatewayid-null/","summary":"\u003ch1 id=\"failed-to-save-kubernetes-service---addonprofilesingressapplicationgatewayconfigapplicationgatewayid-is-invalid\"\u003eFailed to save Kubernetes service - addonProfiles.ingressApplicationGateway.config.applicationGatewayId is invalid\u003c/h1\u003e\n\u003cp\u003eI ran into an issue when deploying Azure Kubernetes services using ARM Templates. We previously set the ingress-agw addon to configure the ingress using an application gateway. We recently moved to the Azure Application Gateway Ingress Controller using Helm and simply set the addon configuration to \u0026rsquo;null\u0026rsquo; but that creates a conflict when making other changes such as changing the SKU (Pricing Tier) of the cluster.\u003c/p\u003e","title":"Failed to save Kubernetes service - addonProfiles.ingressApplicationGateway.config.applicationGatewayId is invalid"},{"content":"Disable Health Probe on Azure Front Door Origin Groups using Bicep If you want to know how\u0026hellip; read on!\nIntroduction For origins with a single backend it is recommended by the Microsoft Learn documentation to disable the health probe to prevent the Front Door from consuming resources on your backend. Because I had troubles disabling the Health Probe using Bicep, because of lacking documentation on how to disable it, specifically for the Front Door Standard / Premium, which seems to belong to the Microsoft.Cdn resource provider. I wanted to share with you how you can disable the Health Probe, as it is quite easy, but if there is no documentation about this then it may take some time to figure it out. Click here to find out how to disable it or just continue reading.\nDisable the health probe according to the (rest, arm) api documentation and reference If you start off with an example template from the documentation you will most likely have health probe enabled, because if you have multiple backends Front Door can determine which backends are healthy, which is nice to have of course.\nIn the portal it is simply ticking a box as seen in the screenshot below:\nAccording to the documentation it should be updated in the origin itself instead of the group:\nBicep reference states it should be configured in the AFDOriginProperties, using EnabledState set to false. See here Front Door rest api tells me exactly the same but that obviously didn\u0026rsquo;t work for me either: See here Disable the health probe in Bicep In order to disable the health probe in Bicep, it turned out it is as simple as omitting the healthProbeSettings object in the Origin Group, so not in the Origin level! See below:\nHealth probing enabled: resource originGroup \u0026#39;Microsoft.Cdn/profiles/origingroups@2021-06-01\u0026#39; = { parent: frontDoorProfile name: \u0026#39;originGroup\u0026#39; properties: { loadBalancingSettings: { sampleSize: 4 successfulSamplesRequired: 3 additionalLatencyInMilliseconds: 0 } healthProbeSettings: { probePath: \u0026#39;/\u0026#39; probeRequestType: \u0026#39;HEAD\u0026#39; probeProtocol: \u0026#39;Https\u0026#39; probeIntervalInSeconds: 100 } sessionAffinityState: \u0026#39;Disabled\u0026#39; } } Health probing disabled resource originGroup \u0026#39;Microsoft.Cdn/profiles/origingroups@2021-06-01\u0026#39; = { parent: frontDoorProfile name: \u0026#39;originGroup\u0026#39; properties: { loadBalancingSettings: { sampleSize: 4 successfulSamplesRequired: 3 additionalLatencyInMilliseconds: 0 } sessionAffinityState: \u0026#39;Disabled\u0026#39; } } After deployment the setting on the Origin Group should look like this:\nI hope this helped you disabling the Health Probes from Bicep, because it took me some time to figure this out, and I couldn\u0026rsquo;t find anything about this via my common used search engine ðŸ˜‰. I will try to make a comment about this on the mentioned documentation via the feedback forms.\nIf you have any questions or remarks about this blog please reach out to me via one of my social media channels or the comments below.\n","permalink":"http://localhost:1313/posts/2022-12-09-disable-health-probe-front-door-premium-bicep/","summary":"\u003ch1 id=\"disable-health-probe-on-azure-front-door-origin-groups-using-bicep\"\u003eDisable Health Probe on Azure Front Door Origin Groups using Bicep\u003c/h1\u003e\n\u003cp\u003eIf you want to know how\u0026hellip; read on!\u003c/p\u003e\n\u003ch2 id=\"introduction\"\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eFor origins with a single backend it is recommended by the \u003ca href=\"https://learn.microsoft.com/en-us/azure/frontdoor/health-probes#disabling-health-probes\"\u003eMicrosoft Learn documentation\u003c/a\u003e to disable the health probe to prevent the Front Door from consuming resources on your backend. Because I had troubles disabling the Health Probe using Bicep, because of lacking documentation on how to disable it, specifically for the Front Door Standard / Premium, which seems to belong to the Microsoft.Cdn resource provider. I wanted to share with you how you can disable the Health Probe, as it is quite easy, but if there is no documentation about this then it may take some time to figure it out. Click \u003ca href=\"#disable-the-health-probe-in-bicep\"\u003ehere\u003c/a\u003e to find out how to disable it or just continue reading.\u003c/p\u003e","title":"Disable Health Probe on Azure Front Door Origin Groups using Bicep"},{"content":"Azure Automation Runbook: Could not convert string to DateTimeOffset I recently started getting issues with different customers in which we use Azure Automation for Update Management. We use the pre- and post runbook functionality for quite some time already, but recently we started getting these errors..\non multiple lines in the runbook output:\n\u0026quot;Could not convert string to DateTimeOffset: 1619773997. Path 'expires_on', line 1, position 2937.\u0026quot;\nWhile researching this issue I figured out it had something to do with Az Powershell and depending on a older or newer module within one of the submodules. (which can be found here{:target=\u0026quot;_blank\u0026quot;})\nHowever I updated the Az Module to the latest available in de Azure Automation account when this came available, so why is this happening? I remembered that back in the days Azure Automation did not have AzPowershell but AzurePowerShell installed, so we installed the required modules for our scripts manually. After the Az Module was supported by the platform for newer accounts (and updating older) we started using this{:target=\u0026quot;_blank\u0026quot;}, but we did not know that modules that were imported before that are not updating\u0026hellip; I found out this is actually also written in the Azure Automation docs page:\nQuote from Microsoft Docs (MSLearn{:target=\u0026quot;_blank\u0026quot;}):\nThe recommended way for this scenario is to first delete the existing Az modules and then perform the update operations to get the latest Az module imported in the Automation account. Such module types, not imported by default, are referred to as Custom. Custom modules will always take preference over default modules For example: If you already have the Az.Aks module imported with version 2.3.0 which is provided by Az module 6.3.0 and you try to update the Az module to the latest 6.4.0 version. The update operation will import all the Az modules from 6.4.0 package, except Az.Aks. To have the latest version of Az.Aks, first delete the existing module and then perform the update operation, or you can also update this module separately as described in Import Az modules to import a different version of a specific module. {: .notice\u0026ndash;warning}\nNow let\u0026rsquo;s fix this:\nIf you look at the modules in your Automation account via the portal you can filter on the module type: \u0026lsquo;Custom\u0026rsquo;, if you see any \u0026lsquo;Az.\u0026rsquo; modules there that could be outdated.\n{: .full}\nAs you can see mine were not updated since february. In order to fix this you can either remove them one by one, or if you like PowerShell use this one-liner:\nPlease only use this script if you know what you are doing! {: .notice\u0026ndash;danger}\nLast but not least just use the Update Az Modules button in the portal to restore all the removed modules to a working state and probably a succeeding runbook again!\nHope this helps out as I couldn\u0026rsquo;t find anything about this on the world wide web.\n","permalink":"http://localhost:1313/posts/2022-11-15-azure-automation-modules/","summary":"\u003ch1 id=\"azure-automation-runbook-could-not-convert-string-to-datetimeoffset\"\u003eAzure Automation Runbook: Could not convert string to DateTimeOffset\u003c/h1\u003e\n\u003cp\u003eI recently started getting issues with different customers in which we use Azure Automation for Update Management. We use the pre- and post runbook functionality for quite some time already, but recently we started getting these errors..\u003c/p\u003e\n\u003cp\u003eon multiple lines in the runbook output:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e\u0026quot;Could not convert string to DateTimeOffset: 1619773997. Path 'expires_on', line 1, position 2937.\u0026quot;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eWhile researching this issue I figured out it had something to do with Az Powershell and depending on a older or newer module within one of the submodules. (which can be found \u003ca href=\"https://github.com/microsoft/Intune-PowerShell-SDK/issues/55\"\u003ehere\u003c/a\u003e{:target=\u0026quot;_blank\u0026quot;})\u003c/p\u003e","title":"Azure Automation Runbook: Could not convert string to DateTimeOffset"},{"content":"Azure Update Management: You have requested to create an update configuration on a machine that is not registered for Update Management We have several customers running with our Update Management solution via Azure Automation. We schedule the deployments via Powershell and Azure DevOps. I have ran into several issues after migrating VMâ€™s to Azure or moving VMâ€™s within Azure.\nSomehow the System Hybrid Worker gets corrupted and does not work anymore, so update deployments will fail with the following warning:\n-image was lost in migration-\nTo fix this I creaed a script. After running the script you can re-create the schedule in Azure Update Management.\nSome things to keep in mind before running the script:\nYou need to be Administrator on the VM that you are trying to run the script on. If you are using SCOM for monitoring, running the script could cause an hiccup because the HealthService service will be restarted. The script removes the System Hybrid Worker information from the registry and removes cache files from the C:\\ProgramÂ Files\\MicrosoftÂ MonitoringÂ Agent\\Agent\\HealthÂ ServiceÂ State folder. If you have any questions let me know in the comments!\nThe most recent script can be found in my Github repo.\n","permalink":"http://localhost:1313/posts/2020-03-27-azure-update-management-you-have-requested-to-create-an-update-configuration-on-a-machine-that-is-not-registered-for-update-management/","summary":"\u003ch1 id=\"azure-update-management-you-have-requested-to-create-an-update-configuration-on-a-machine-that-is-not-registered-for-update-management\"\u003eAzure Update Management: You have requested to create an update configuration on a machine that is not registered for Update Management\u003c/h1\u003e\n\u003cp\u003eWe have several customers running with our Update Management solution via Azure Automation. We schedule the deployments via Powershell and Azure DevOps. I have ran into several issues after migrating VMâ€™s to Azure or moving VMâ€™s within Azure.\u003c/p\u003e\n\u003cp\u003eSomehow the System Hybrid Worker gets corrupted and does not work anymore, so update deployments will fail with the following warning:\u003c/p\u003e","title":"Azure Update Management: You have requested to create an update configuration on a machine that is not registered for Update Management"}]